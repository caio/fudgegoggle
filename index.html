<!DOCTYPE html>
<html lang="en">
<head>
    <title>FudgeGoggle</title>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’©</text></svg>">
</head>
<body>
<h1>FudgeGoggle</h1>

<video autoplay></video>
<canvas hidden></canvas>

<script type="module">
import init, {qr_decode} from './pkg/fudgegoggle.js';
await init();

var decodeIntervalId;

function decode() {
    const video = document.querySelector("video");
    const width = video.videoWidth;
    const height = video.videoHeight;

    const canvas = document.querySelector("canvas");
    canvas.width = width;
    canvas.height = height;

    const context = canvas.getContext("2d");
    // I was calling `context.drawImage(video, width, height)` instead
    // ...Took me over 1h to realise it wasn't what I wanted :(
    context.drawImage(video, 0, 0);

    const data = context.getImageData(0, 0, width, height).data;

    try {
        const decoded = qr_decode(width, height, data);
        console.log(`Done! Decoded: ${decoded}`);

        // Stop the video stream and the attempts to decode it
        clearInterval(decodeIntervalId);
        video.srcObject.getTracks().forEach(track => track.stop());
        video.hidden = true;
    } catch (err) {
        console.error(err);
    }
}

navigator.mediaDevices.getUserMedia({video: true})
    .then(stream => {
        document.querySelector("video").srcObject = stream;
        decodeIntervalId = setInterval(decode, 1000);
    })
    .catch(console.error);


</script>
</body>
</html>
